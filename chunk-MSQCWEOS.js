import{g,h as l}from"./chunk-VPHT4GIH.js";import{P as p,U as m}from"./chunk-4INGPXGM.js";import{i}from"./chunk-ODN5LVDJ.js";function d(e){return{id:e.id,title:e.title,description:e.description,status:e.status,textContentId:e.text_content_id,language:e.language,bookClubId:e.book_club_id??void 0,hosts:[],currentReaderId:e.current_reader_id??void 0,currentPosition:e.current_position??{paragraphIndex:0,wordIndex:0},readingOrder:e.reading_order??void 0,readingTurns:e.reading_turns??void 0,audienceCount:e.audience_count??0,scheduledTime:e.scheduled_time?new Date(e.scheduled_time):new Date(0),startTime:e.start_time?new Date(e.start_time):void 0,endTime:e.end_time?new Date(e.end_time):void 0,tags:Array.isArray(e.tags)?e.tags:[],createdAt:e.created_at?new Date(e.created_at):new Date(0),updatedAt:e.updated_at?new Date(e.updated_at):new Date(0)}}var h=9e4;function E(e){return{id:e.id,roomId:e.room_id,userId:e.user_id,assignedAt:e.assigned_at?new Date(e.assigned_at):new Date(0)}}var D=e=>{let t=0;for(let o=0;o<e.length;o++){let r=e.charCodeAt(o);t=(t<<5)-t+r,t&=t}return t.toString()},S=class e{supabaseClient=m(g);cacheService=m(l);constructor(){}getRoom(t){return i(this,null,function*(){let o=`room:${t}`,r=this.cacheService.getEntry(o);if(r&&!(new Date().getTime()-r.timestamp>h))return r.response;let{data:s,error:a}=yield this.supabaseClient.supabase.from("rooms").select("*").eq("id",t).single();if(a)throw new Error(a.message);return d(s)})}getRooms(){return i(this,arguments,function*(t={}){let o=`rooms:${D(JSON.stringify(t))}`,r=this.cacheService.getEntry(o);if(r){if(!(new Date().getTime()-r.timestamp>h))return console.log(`[RoomService] Cache HIT for key: ${o}`),r.response;console.log(`[RoomService] Cache EXPIRED for key: ${o}`)}else console.log(`[RoomService] Cache MISS for key: ${o}`);let s=t.page??1,a=t.pageSize??12,n=(s-1)*a,u=n+a-1,c=this.supabaseClient.supabase.from("rooms").select("*",{count:"exact"}).range(n,u);switch(t.status&&(c=c.eq("status",t.status)),t.languages&&t.languages.length>0&&(c=c.in("language",t.languages)),t.search&&(c=c.textSearch("title",t.search,{type:"plain"})),t.sortBy){case"az":c=c.order("title",{ascending:!0});break;case"recent":default:c=c.order("scheduled_time",{ascending:!1});break}let{data:_,error:y,count:C}=yield c;if(y)throw new Error(y.message);let w={rooms:(_??[]).map(d),total:C??0};return console.log(`[RoomService] Caching result for key: ${o}`),this.cacheService.set(o,w),w})}createRoom(t){return i(this,null,function*(){this.cacheService.clear(),console.log("[RoomService] Cache cleared due to createRoom.");let{data:o,error:r}=yield this.supabaseClient.supabase.from("rooms").insert(t).select().single();if(r)throw new Error(r.message);return d(o)})}updateRoom(t,o){return i(this,null,function*(){this.cacheService.clear(),console.log("[RoomService] Cache cleared due to updateRoom.");let{data:r,error:s}=yield this.supabaseClient.supabase.from("rooms").update(o).eq("id",t).select().single();if(s)throw new Error(s.message);return d(r)})}deleteRoom(t){return i(this,null,function*(){this.cacheService.clear(),console.log("[RoomService] Cache cleared due to deleteRoom.");let{error:o}=yield this.supabaseClient.supabase.from("rooms").delete().eq("id",t);if(o)throw new Error(o.message)})}joinRoom(t,o){return i(this,null,function*(){this.cacheService.clear(),console.log("[RoomService] Cache cleared due to joinRoom.")})}leaveRoom(t,o){return i(this,null,function*(){this.cacheService.clear(),console.log("[RoomService] Cache cleared due to leaveRoom.")})}getRoomHosts(t){return i(this,null,function*(){let o=`room-hosts:${t}`,r=this.cacheService.getEntry(o);if(r&&!(new Date().getTime()-r.timestamp>h))return r.response;let{data:s,error:a}=yield this.supabaseClient.supabase.from("room_hosts").select("*").eq("room_id",t);if(a)throw new Error(a.message);let n=(s??[]).map(E);return this.cacheService.set(o,n),n})}static \u0275fac=function(o){return new(o||e)};static \u0275prov=p({token:e,factory:e.\u0275fac,providedIn:"root"})};var f=9e4,T=e=>{let t=0;for(let o=0;o<e.length;o++){let r=e.charCodeAt(o);t=(t<<5)-t+r,t&=t}return t.toString()};function v(e){return{id:e.id,title:e.title,author:e.author,content:e.content,type:e.type,genre:e.genre,readingLevel:e.reading_level,coverImageUrl:e.cover_image_url,uploaderId:e.uploader_id,isPublicDomain:e.is_public_domain,wordCount:e.word_count,estimatedReadingTime:e.estimated_reading_time,rating:e.rating,createdAt:e.created_at?new Date(e.created_at):new Date(0),updatedAt:e.updated_at?new Date(e.updated_at):new Date(0)}}var R=class e{supabase=m(g).supabase;cacheService=m(l);constructor(){}getTextContent(t){return i(this,null,function*(){let o=`text-content:${t}`,r=this.cacheService.getEntry(o);if(r&&!(new Date().getTime()-r.timestamp>f))return r.response;let{data:s,error:a}=yield this.supabase.from("text_contents").select("*").eq("id",t);if(a)throw new Error(a.message);let n=s[0]?v(s[0]):void 0;return this.cacheService.set(o,n),n})}getTextContentTitle(t){return i(this,null,function*(){let o=`text-content-title:${t}`,r=this.cacheService.getEntry(o);if(r&&!(new Date().getTime()-r.timestamp>f))return r.response;let{data:s,error:a}=yield this.supabase.from("text_contents").select("title").eq("id",t);if(a)throw new Error(a.message);let n=s[0]?.title;return this.cacheService.set(o,n),n})}getTextContentByIds(t){return i(this,null,function*(){let o=`text-contents-by-ids:${T(JSON.stringify(t))}`,r=this.cacheService.getEntry(o);if(r&&!(new Date().getTime()-r.timestamp>f))return r.response;let{data:s,error:a}=yield this.supabase.from("text_contents").select("*").in("id",t);if(a)throw new Error(a.message);let n=(s??[]).map(v);return this.cacheService.set(o,n),n})}static \u0275fac=function(o){return new(o||e)};static \u0275prov=p({token:e,factory:e.\u0275fac,providedIn:"root"})};export{S as a,R as b};
